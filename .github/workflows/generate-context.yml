name: Generate AI Assistant Context (Manual)
permissions:
  contents: write

on:
  push:
    branches: [main]
    paths:
      - 'noodles-editor/src/**'
      - 'docs/**'
      - 'noodles-editor/public/examples/**'
  workflow_dispatch:

jobs:
  generate-context:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version-file: '.nvmrc'

      - name: Enable Corepack
        run: corepack enable yarn

      - name: Cache yarn dependencies for app
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: |
            noodles-editor/.yarn/cache
            noodles-editor/.yarn/unplugged
            noodles-editor/.yarn/install-state.gz
          key: ${{ runner.os }}-yarn-app-${{ hashFiles('noodles-editor/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-app-

      - name: Cache yarn dependencies for website
        uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
        with:
          path: |
            website/.yarn/cache
            website/.yarn/unplugged
            website/.yarn/install-state.gz
          key: ${{ runner.os }}-yarn-website-${{ hashFiles('website/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-website-

      - name: Install dependencies
        run: yarn install:all

      - name: Clean old context files
        run: |
          cd noodles-editor
          rm -rf public/app/context/*
          mkdir -p public/app/context

      - name: Generate context bundles
        run: |
          cd noodles-editor
          yarn generate:context

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./noodles-editor/public/context
          destination_dir: app/context
          keep_files: true
